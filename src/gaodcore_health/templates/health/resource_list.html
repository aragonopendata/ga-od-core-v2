{% extends 'health/base.html' %}

{% block title %}Resource Health Monitor{% endblock %}

{% block content %}
<button class="refresh-button" onclick="window.location.reload()">
    üîÑ Refresh Data
</button>

<!-- Filter Controls -->
<div class="filter-controls">
    <label>Filter by Status:</label>
    <a href="?status=all" class="filter-button {% if current_status_filter == 'all' %}active{% endif %}">All</a>
    <a href="?status=healthy" class="filter-button {% if current_status_filter == 'healthy' %}active{% endif %}">Healthy</a>
    <a href="?status=unhealthy" class="filter-button {% if current_status_filter == 'unhealthy' %}active{% endif %}">Unhealthy</a>
    <a href="?status=unknown" class="filter-button {% if current_status_filter == 'unknown' %}active{% endif %}">Unknown</a>
</div>

<!-- Filter Info -->
{% if connector %}
<div class="filter-info" style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    <h3 style="margin: 0 0 10px 0; color: #333;">
        üìä Resources for Connector: <span style="color: #667eea;">{{ connector.name }}</span>
    </h3>
    <p style="margin: 0; color: #666;">
        <strong>Type:</strong> {{ connector.connector_type|default:"Unknown" }} |
        <strong>URI:</strong> {{ connector.uri }}
    </p>
</div>
{% endif %}

<!-- Summary Cards -->
<div class="summary-cards">
    <div class="stat-card total">
        <div class="stat-number">{{ resource_health_data.total_count }}</div>
        <div class="stat-label">Total Resources</div>
    </div>
    <div class="stat-card healthy">
        <div class="stat-number">{{ resource_health_data.healthy_count }}</div>
        <div class="stat-label">Healthy</div>
    </div>
    <div class="stat-card unhealthy">
        <div class="stat-number">{{ resource_health_data.unhealthy_count }}</div>
        <div class="stat-label">Unhealthy</div>
    </div>
    <div class="stat-card unknown">
        <div class="stat-number">{{ resource_health_data.unknown_count }}</div>
        <div class="stat-label">Unknown</div>
    </div>
</div>

<!-- Resources Table -->
{% if resource_health_data.resources %}
<div class="health-table">
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                {% if not connector %}
                <th>Connector</th>
                {% endif %}
                <th>Status</th>
                <th>Last Check</th>
            </tr>
        </thead>
        <tbody>
            {% for resource in resource_health_data.resources %}
            <tr class="table-row {{ resource.status_class }}"
                onclick="window.location.href='{% url 'gaodcore_health:resource_detail' resource.id %}';"">
                <td>
                    <span class="item-id">{{ resource.id }}</span>
                </td>
                <td>
                    <span class="item-name">{{ resource.name }}</span>
                </td>
                {% if not connector %}
                <td>
                    <a href="{% url 'gaodcore_health:connector_resources' resource.connector_id %}"
                       class="connector-link">
                        {{ resource.connector_name }}
                    </a>
                </td>
                {% endif %}
                <td>
                    <span class="status-icon">
                        {% if resource.status_class == 'healthy' %}
                            ‚úÖ
                        {% elif resource.status_class == 'unhealthy' %}
                            ‚ùå
                        {% else %}
                            ‚ö†Ô∏è
                        {% endif %}
                    </span>
                </td>
                <td>
                    <span class="last-check">
                        {% if resource.last_check %}
                            {{ resource.last_check|date:"M d, H:i" }}
                        {% else %}
                            Never
                        {% endif %}
                    </span>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
{% if is_paginated %}
<div class="pagination">
    <span class="step-links">
        {% if page_obj.has_previous %}
            <a href="?page=1{% if current_status_filter != 'all' %}&status={{ current_status_filter }}{% endif %}">&laquo; First</a>
            <a href="?page={{ page_obj.previous_page_number }}{% if current_status_filter != 'all' %}&status={{ current_status_filter }}{% endif %}">Previous</a>
        {% endif %}

        <span class="current">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
        </span>

        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if current_status_filter != 'all' %}&status={{ current_status_filter }}{% endif %}">Next</a>
            <a href="?page={{ page_obj.paginator.num_pages }}{% if current_status_filter != 'all' %}&status={{ current_status_filter }}{% endif %}">Last &raquo;</a>
        {% endif %}
    </span>
</div>
{% endif %}

{% else %}
<div class="empty-state">
    <h3>No Resources Found</h3>
    {% if connector %}
        <p>No enabled resources are configured for connector <strong>{{ connector.name }}</strong>.</p>
        <p>Create resources for this connector in the resource management interface.</p>
    {% else %}
        <p>No enabled resources are currently configured for monitoring.</p>
        <p>Create resources in the resource management interface.</p>
    {% endif %}
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // Add click handler for resource table rows
    document.querySelectorAll('.table-row').forEach(row => {
        row.addEventListener('click', function(e) {
            // Don't navigate if clicking on a link within the row
            if (e.target.tagName === 'A') {
                return;
            }
            const url = this.getAttribute('onclick').match(/'([^']+)'/)[1];
            window.location.href = url;
        });
    });
</script>
{% endblock %}
